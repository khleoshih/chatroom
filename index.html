<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <link rel="stylesheet" href="css/bootstrap.css" type = "text/css" />
  <style>
    html,body,.col-md-12{
      height:96%;
    }
    .row{
      height: 90%;
    }
    .row > div {
      height:100%;
    }
    .nav-font{
      font-size: 16pt;
    }
  </style>
  </head>
  <body>
    <div id="top_bar" class="page-header">
      <h1> ChatRoom </h1>
    </div>
    <div id="container" class="row">
      <div id="chat_container" class="col-md-9">
        <div id="chat_upper" style = "overflow: auto; height:90%">
          <div id="public" class="chat_main"></div>						
        </div>
        <form id="input_bar" class="input-group" style="position: relative; bottom: 0%; width:100%; height:10%">
          <input id="input" style="width:90%" type="text" class="form-control" placeholder="Write a message..." autocomplete="off"/>
          <button id="send" style="width:10%" class="btn btn-success">Send</button>
        </form>
      </div>
      <div id="flist_container" class="col-md-3" style="border-left: 1px solid #dddddd">
        <div id="flist_body" style="overflow: auto; height:90%">
          <ul class="nav nav-pills nav-stacked nav-font" id="flist">
            <li id="online_public"><a href="#public">public</a></li>
          </ul>
        </div>
      </div>
    </div>
  </body>
</html>

<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script>
  var username = prompt('your name','');
  var windows = "#public";
  $(function () {
    var socket = io();
    socket.emit('username', username);
    $('form').submit(function(){
      socket.emit('chat message', {msg: $('#input').val(), obj: windows.substr(1)});
      
      let head = $("<div>", {
        "class": "panel-heading",
        text: username
      });
      let message = $("<div>", {
        "class": "panel-body",
        text: $('#input').val()
      });
      let div = $("<div>", {
        "class": "panel panel-info"
      });
      div.append(head, message);
      if(windows !== "#public" && windows !== "#" + username){
        $(windows).append(div);
      }
      $(windows).parent().scrollTop($(windows).parent()[0].scrollHeight - $(windows).parent()[0].clientHeight);
      $('#input').val('');
      return false;
    });
    socket.on('allusers', function(users){
      users.forEach(function(user_name){
        $("#chat_upper").append(
          $("<div>", {class:"chat_main", id:user_name})
        );
        $("#data").hide();
        $("#flist").append(
          $("<li>",{id: "online_" + user_name}).append(
            $("<a>", {href: "#" + user_name}).text(user_name)
          )
        );
        
        $("#online_" + user_name).click(function() {
          var $this = $(this),
            _clickTab = $this.find('a').attr('href');
          $this.addClass('active').siblings('.active').removeClass('active');
          $(_clickTab).stop(false, true).fadeIn().siblings().hide();
          windows = _clickTab;
          $(windows).parent().scrollTop($(windows).parent()[0].scrollHeight - $(windows).parent()[0].clientHeight);
          let badge = $("#online_"+windows.substr(1)).find("a").find("span");
          if (badge.length !== 0){
            badge.remove();
          }
          return false;
        }).find('a').focus(function(){
          this.blur();
        });
      });
    });

    socket.on('chat', function(msg){
      let head = $("<div>", {
        "class": "panel-heading",
        text: msg.head
      });
      let message = $("<div>", {
        "class": "panel-body",
        text: msg.message
      });
      let div = $("<div>", {
        "class": "panel panel-info"
      });
      div.append(head, message);
      if (msg.to === "public"){
        $("#public").append(div);
        if(windows !== "#public"){
          $("#public").hide();
        }
        else{
          $(windows).parent().scrollTop($(windows).parent()[0].scrollHeight - $(windows).parent()[0].clientHeight);
        }
        let badge = $("#online_public").find("span");
        if (windows !== "#public" || $(windows).parent().scrollTop() !== $(windows).parent()[0].scrollHeight - $(windows).parent()[0].clientHeight){
          if (badge.length === 0){
            $("#online_public").find("a").append(
              $("<span>",{"class": "badge"}).text(1)
            );
          }
          else{
            let unread = +badge.text();
            badge.text(unread + 1);
          }
        }
      }
      else{
        $("#" + msg.head).append(div);
        if(windows !== "#" + msg.head){
          $("#" + msg.head).hide();
        }
        else{
          $(windows).parent().scrollTop($(windows).parent()[0].scrollHeight - $(windows).parent()[0].clientHeight);
        }
        let badge = $("#online_" + msg.head).find("span");
        if (windows !== "#" + msg.head || $(windows).parent().scrollTop() !== $(windows).parent()[0].scrollHeight - $(windows).parent()[0].clientHeight){
          if (badge.length === 0){
            $("#online_" + msg.head).find("a").append(
              $("<span>",{"class": "badge"}).text(1)
            );
          }
          else{
            let unread = +badge.text();
            badge.text(unread + 1);
          }
        }
      }
    });

    socket.on('online',function(data){
      $("#chat_upper").append(
        $("<div>", {class:"chat_main", id: data})
      );
      $("#data").hide();
      $("#flist").append(
        $("<li>",{id: "online_" + data}).append(
          $("<a>", {href: "#" + data}).text(data)
        )
      );
      $("#online_" + data).click(function() {
        var $this = $(this),
          _clickTab = $this.find('a').attr('href');
        $this.addClass('active').siblings('.active').removeClass('active');
        $(_clickTab).stop(false, true).fadeIn().siblings().hide();
        windows = _clickTab;
        $(windows).parent().scrollTop($(windows).parent()[0].scrollHeight - $(windows).parent()[0].clientHeight);
        let badge = $("#online_"+windows.substr(1)).find("a").find("span");
        if (badge.length !== 0){
          badge.remove();
        }
        return false;
      }).find('a').focus(function(){
        this.blur();
      });
		});

    socket.on('offline', function(data){
      $("#online_" + data).remove();
      $("#" + data).remove();
    });

    $(function(){      
      var _showTab = 0;
      var $dfchat = $('ul li').eq(_showTab).addClass('active');
      $($dfchat.find('a').attr('href')).siblings().hide();

      $('ul li').click(function() {
        var $this = $(this),
          _clickTab = $this.find('a').attr('href');
        $this.addClass('active').siblings('.active').removeClass('active');

        $(_clickTab).stop(false, true).fadeIn().siblings().hide();
        windows = _clickTab;
        $(windows).parent().scrollTop($(windows).parent()[0].scrollHeight - $(windows).parent()[0].clientHeight);
        let badge = $("#online_"+windows.substr(1)).find("a").find("span");
        if (badge.length !== 0){
          badge.remove();
        }
        return false;
      }).find('a').focus(function(){
        this.blur();
      });
    });
  });
</script>